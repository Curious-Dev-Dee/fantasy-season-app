/* =========================
   INIT
========================= */
async function initHome() {
  const { data: { session } } = await supabase.auth.getSession();
  
  // If no session, redirect to login
  if (!session) {
    window.location.href = "index.html"; 
    return;
  }

  const userId = session.user.id;
  
  // Check profile first before loading anything else
  await loadProfile(userId);
  await loadDashboard(userId);
}

/* =========================
   PROFILE LOGIC
========================= */
async function loadProfile(userId) {
  // Try to fetch the profile
  let { data: profile, error } = await supabase
    .from("user_profiles")
    .select("*")
    .eq("user_id", userId)
    .maybeSingle();

  // If no profile exists yet OR it's marked as incomplete
  if (!profile || profile.profile_completed === false) {
    showProfileModal();
  } else {
    renderProfile(profile);
  }
}

function showProfileModal() {
  modal.classList.remove("hidden");
  // Optional: Prevent closing by clicking outside if you want to force completion
}

// SAVE PROFILE EVENT
saveBtn.addEventListener("click", async () => {
  const { data: { session } } = await supabase.auth.getSession();
  const userId = session?.user.id;

  const fullName = fullNameInput.value.trim();
  const teamName = teamNameInput.value.trim();

  if (!fullName || !teamName) {
    alert("Please fill in both Name and Team Name.");
    return;
  }

  saveBtn.disabled = true;
  saveBtn.textContent = "Saving...";

  try {
    // Upsert will insert if new, update if exists
    const { error } = await supabase
      .from("user_profiles")
      .upsert({
        user_id: userId,
        full_name: fullName,
        team_name: teamName,
        profile_completed: true, // Mark as complete
        updated_at: new Date()
      });

    if (error) throw error;

    // Success! Hide modal and refresh data
    modal.classList.add("hidden");
    location.reload(); // Reload to initialize everything with new profile

  } catch (error) {
    alert("Error saving profile: " + error.message);
    saveBtn.disabled = false;
    saveBtn.textContent = "Save & Continue";
  }
});