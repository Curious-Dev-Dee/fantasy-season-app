/* =========================
   CORE DASHBOARD LOGIC (UPDATED)
========================= */
async function fetchHomeData(userId) {
    const { data, error } = await supabase
        .from('home_dashboard_view')
        .select('*')
        .eq('user_id', userId)
        .maybeSingle();

    if (error || !data) {
        console.error("Dashboard fetch error:", error);
        return;
    }

    existingProfile = data;

    // ... (Keep Header, Profile, and Stat logic the same) ...
    scoreElement.textContent = data.total_points || 0;
    rankElement.textContent = data.user_rank > 0 ? `#${data.user_rank}` : "â€”";
    
    // Dynamic Sub Display
    subsElement.textContent = data.subs_remaining;

    // 3. Match Logic (Fixing the NaN and Missing Data)
    const match = data.upcoming_match;

    if (match) {
        // Log to debug if needed: console.log("Next Match Data:", match);
        
        matchTeamsElement.textContent = `${match.team_a_code} vs ${match.team_b_code}`;

        // Render Real Team Logos
        const updateTeamLogo = (path, elementId) => {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (path) {
                const { data: logoData } = supabase.storage.from('team-logos').getPublicUrl(path);
                el.style.backgroundImage = `url(${logoData.publicUrl})`;
                el.style.display = "block";
            } else {
                el.style.display = "none";
            }
        };

        updateTeamLogo(match.team_a_logo, "teamALogo");
        updateTeamLogo(match.team_b_logo, "teamBLogo");
        
        if (match.status === 'abandoned') {
            if (countdownInterval) clearInterval(countdownInterval);
            matchTimeElement.innerHTML = `<span style="color: #ef4444; font-weight: 800;"><i class="fas fa-ban"></i> Match Abandoned</span>`;
            return;
        }

        // Check if locked OR if time has already passed
        const startTime = new Date(match.actual_start_time).getTime();
        const now = new Date().getTime();

        if (match.is_locked || match.status === 'locked' || startTime <= now) {
            if (countdownInterval) clearInterval(countdownInterval);
            matchTimeElement.innerHTML = `<span style="color: #94a3b8;"><i class="fas fa-lock"></i> Match Started</span>`;
            editButton.disabled = true;
            editButton.textContent = "Locked";
            editButton.style.background = "#1e293b";
        } else {
            // FIX: Ensure startTime is a valid number before calling countdown
            if (!isNaN(startTime)) {
                startCountdown(match.actual_start_time);
            } else {
                matchTimeElement.textContent = "TBD";
            }
            
            editButton.disabled = false;
            editButton.textContent = "Change";
            editButton.style.background = "#9AE000";
        }
    } else {
        matchTeamsElement.textContent = "No upcoming match";
        editButton.disabled = true;
        document.getElementById("teamALogo").style.display = "none";
        document.getElementById("teamBLogo").style.display = "none";
    }
}